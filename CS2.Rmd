---
title: "Case Study 2"
author:   
  -  Emily Gentles (Writer)
  -  Weiyi Liu (Coordinator and Checker)
  -  Jack McCarthy (Presenter)  
  -  Qinzhe Wang (Coder)  
date: "10/28/2021"
output: 
  pdf_document:
fontsize: 11pt
geometry: "left=1.5cm,right=1.5cm,top=1.25cm,bottom=1.75cm"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = F, message = F, warning =F)
library(tidyverse)
library(lme4)
library(pROC)
library(kableExtra)
library(performance)
library(lattice)
library(brms)
library(reshape2)
library(dplyr)
library(gridExtra)
library(cowplot)
library(arm)
library(knitr)
```

# Introduction

Voter turnout is a huge topic of interest for both pollsters and candidates, especially around presidential elections and with particular focus on swing states, such as North Carolina. In this case study we will use North Carolina registration and turnout data, by county, for the 2020 election year. We wish to investigate what demographic factors such as age, race, and party affect turnout and whether turnout differs by county. 

```{r, echo = FALSE}
# Explanation of abbreviations: https://s3.amazonaws.com/dl.ncsbe.gov/data/layout_ncvoter.txt
# contains info about the aggregate counts of voters who actually voted by demographic variables

votes <- read.table("history_stats_20201103.txt", header = TRUE, fill = TRUE, sep = '\t')

# contains info about the aggregate counts of registered voters by demographic variables
registers <- read.table("voter_stats_20201103.txt", header = TRUE, fill = TRUE, sep = '\t')
```

```{r, echo = FALSE}
# set "" or " " to NA
registers[registers == ""] <- NA
registers[registers == " "] <- NA
votes[votes == " "] <- NA

# unique(registers$election_date) # "11/03/2020" NA 
# unique(registers$stats_type) # "history" NA  
# unique(registers$update_date) # "01/13/2021" NA     

# remove above three columns

registers <- registers %>%
  dplyr::select(-election_date, -stats_type, -update_date)
votes <- votes %>%
  dplyr::select(-election_date, -stats_type, -update_date)

votes <- votes %>%
  mutate(total_voters = as.numeric(total_voters))

registers <- registers %>%
  mutate(total_voters2 = as.numeric(total_voters))

```

## Data Cleaning

Note that we renamed the `history_stats_20201103` data as votes and the `voter_stats_20201103` data as registers. Within the votes and registers data we aggregated the total voters variable by taking the sum, ignoring NA values, and then left joined votes to registers on county and all the demographic features. We next replaced any NA values in total votes with 0. While these values are unlikely to be exactly 0, we chose to do this in order to preserve the information that was present as the alternative would be to throw the entire row away. After this we dropped all of the rows containing NA values in any of the other columns. Since total voters is one of the main variables we care about it made sense to preserve as many rows as possible but if we replaced every NA value in the data with 0 that may potentially introduce a lot of error into the data, as the values are unlikely to be exactly 0, so we instead dropped all of the rows containing NA values, leaving us with 51,883 rows. We next randomly sampled 30 counties to utilize in our analysis, leaving our final data with 16,439 rows and, after de-aggregation, 1,908,907 individuals. 

```{r, echo = FALSE}
votes <- votes %>%
  group_by(county_desc, age, party_cd, race_code, ethnic_code, sex_code) %>%
  summarize(total_vot = sum(total_voters,na.rm =T))

data <- registers %>%
  group_by(county_desc, party_cd, race_code, ethnic_code, sex_code, age) %>%
  summarize(total_reg = sum(total_voters2, na.rm= T)) %>%
  left_join(votes, by = c("county_desc", "age", "party_cd", "race_code",
                      "ethnic_code", "sex_code"))



```


```{r, echo = FALSE}
data <- data %>%
  mutate(total_vot = as.numeric(total_vot), 
         total_reg = as.numeric(total_reg))
         # county_desc = as.factor(county_desc), 
         # party_cd = as.factor(party_cd), 
         # race_code = as.factor(race_code), 
         # sex_code = as.factor(sex_code), 
         # ethnic_code = as.factor(ethnic_code), 
         # age = as.factor(age))

```

```{r, echo = FALSE}
data$total_vot <- ifelse(is.na(data$total_vot), 0, data$total_vot)

data$total_vot <- ifelse(data$total_vot <= data$total_reg, data$total_vot, data$total_reg)

data <- data %>%
  drop_na()

# 51883 rows
```



```{r, echo = FALSE}
set.seed(10)
counties <- sample(unique(data$county_desc), 30)

data <- data %>%
  filter(county_desc %in% counties)

# 16439 rows
```

```{r, echo = FALSE}
data$race_code <- recode_factor(data$race_code, M = "Multiracial", U = "Undesignated")
data2 <- data %>%
  drop_na() %>%
  mutate(total_not_vote = total_reg - total_vot) %>%
  pivot_longer(cols = c("total_vot", "total_not_vote"), names_to = "vote_or_not", values_to = "prob") %>%
  mutate(vote_or_not = ifelse(vote_or_not == "total_vot", 1, 0)) %>%
  mutate(row_expand = map(prob, ~rep_len(1, .x))) %>%
  unnest(cols = c(row_expand)) %>%
  dplyr::select(-prob, -row_expand)

# 1,908,907 individuals
```

## EDA

Below we see that most counties have a turnout rate over 70% with the average of all counties being 73%. The lowest turnout rate of 61% is from Robeson county. We also see that two counties, Forsyth and Cabarrus, have many more registered voters than the other sampled counties. When looking at race, age, gender, ethnicity, and party individually (plots in appendix) we found that white people had the highest turnout and number of voters registered while multiracial people had the lowest turnout rate, along with people of race 'other', and the smallest number of voters registered. The Republican party had the highest turnout while the Libertarian party had the lowest turnout. Both the Green party and the Constitution party had the lowest number of voters registered, less than 1500 each, so we combined these categories to provide our model with computational stability. When looking at ethnicities, people of Hispanic/Latinx ethnicity had both the lowest number of voters registered and turnout, a 20 point difference compared to people who weren't of Hispanic/Latinx ethnicity. Turnout rate varied very little by gender although people of unknown gender had the smallest number of voters registered. Looking at age we see that the age group of people 18-25 had both the lowest number of voters registered and turnout rate, a difference of 27 points when compared to those 66 and older. However, the age group of people 41-65 had the largest number of voters registered, nearly triple that of the 18-25 age group.

```{r, echo = FALSE, include = FALSE}
table(data2$vote_or_not)

turnout_rate <- sum(data$total_vot) / sum(data$total_reg)
data.frame(group = "Total", turnout_rate = turnout_rate)
```


### Turnout Rate

```{r, warning= F, fig.width= 10, echo = FALSE}
p1 <- data %>%
  group_by(county_desc) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop",
            n = sum(total_reg)) %>%
  mutate(turnout_rate = total_vot / total_reg) %>%
  ggplot( aes(x = fct_reorder(county_desc,n), y = turnout_rate)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("County") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), hjust = -0.3) +
  ggtitle("Turnout Rate by County") +
    theme(plot.title = element_text(hjust = 0.5)) +
  geom_hline(yintercept = turnout_rate, color = 'red') +
  coord_flip() 

p2 <- data %>%
  group_by(county_desc) %>%
  summarize(n = sum(total_reg), .groups="drop") %>%
  ggplot( aes(x = fct_reorder(county_desc,n), y = n)) +
  geom_bar(stat = "identity") +
  xlab("Party") + ylab("Sample size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.2) +
  ggtitle("Registered Voters by County") +
    theme(plot.title = element_text(hjust = 0.5)) +
  ylim(0,3.15e5) +
  coord_flip() 

 grid.arrange(p1,p2, nrow= 1)
```




```{r, warning= F, fig.width= 10, fig.height= 4, echo = FALSE, include=FALSE}
p3 <- data %>%
  group_by(race_code) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg) %>%
  dplyr::select(group = race_code, turnout_rate) %>%
  ggplot( aes(x = group, y = turnout_rate)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Race") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), hjust = -0.4) +
  ggtitle("Turnout rate vs. Race") +
    theme(plot.title = element_text(hjust = 0.5)) +
    coord_flip()



p4 <- data %>%
  group_by(race_code) %>%
  summarize(n = sum(total_reg), .groups="drop") %>%
  ggplot( aes(x = race_code, y = n)) +
  geom_bar(stat = "identity") +
  xlab("Party") + ylab("Sample size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.2) +
  ggtitle("Registered Voters vs. Race") +
    theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()

grid.arrange(p3,p4, nrow= 1)


data$race_code <- droplevels(data$race_code, 'P')
data <- data %>%
  drop_na()
```





```{r, warning= F, fig.width= 10, fig.height= 4, echo = FALSE, include=FALSE}
p5 <- data %>%
  group_by(party_cd) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg) %>%
  dplyr::select(group = party_cd, turnout_rate) %>%
  ggplot( aes(x = group, y = turnout_rate)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Party") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), vjust = -0.5) +
  ggtitle("Turnout rate vs. Party") +
    theme(plot.title = element_text(hjust = 0.5))  +
    coord_flip()

p6 <- data %>%
  group_by(party_cd) %>%
  summarize(n = sum(total_reg), .groups="drop") %>%
  ggplot( aes(x = party_cd, y = n)) +
  geom_bar(stat = "identity") +
  xlab("Party") + ylab("Sample size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.2) +
  ggtitle("Registered Voters vs. Party") +
    theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()

grid.arrange(p5,p6, nrow= 1)


# "CST","GRE" have small smaple size (50,25) and similar turnout rate (0.16,0.15)
data$party_cd <- ifelse(data$party_cd %in% c("CST","GRE"),"CST_GRE",as.character(data$party_cd))


```



```{r, warning= F, fig.width= 10, fig.height= 3, echo = FALSE, include=FALSE}
p7 <- data %>%
  group_by(ethnic_code) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg) %>%
  dplyr::select(group = ethnic_code, turnout_rate) %>%
  ggplot( aes(x = group, y = turnout_rate)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Ethnic") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), vjust = -0.5) +
  ggtitle("Turnout rate vs. Ethnic") +
    theme(plot.title = element_text(hjust = 0.5))+
    coord_flip()

p8 <- data %>%
  group_by(ethnic_code) %>%
  summarize(n = sum(total_reg), .groups="drop") %>%
  ggplot( aes(x = ethnic_code, y = n)) +
  geom_bar(stat = "identity") +
  xlab("Party") + ylab("Sample size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.2) +
  ggtitle("Registered Voters vs. Ethnic") +
    theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()

grid.arrange(p7,p8, nrow= 1)

```





```{r, warning= F, fig.width= 10, fig.height= 3, echo = FALSE, include=FALSE}
 p9 <- data %>%
  group_by(sex_code) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg) %>%
  dplyr::select(group = sex_code, turnout_rate) %>%
  ggplot( aes(x = group, y = turnout_rate)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Sex") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), vjust = -0.5) +
  ggtitle("Turnout rate vs. Sex") +
    theme(plot.title = element_text(hjust = 0.5)) + 
    coord_flip()

p10 <- data %>%
  group_by(sex_code) %>%
  summarize(n = sum(total_reg), .groups="drop") %>%
  ggplot( aes(x = sex_code, y = n)) +
  geom_bar(stat = "identity") +
  xlab("Party") + ylab("Sample size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.2) +
  ggtitle("Registered Voters vs. Sex") +
    theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()

grid.arrange(p9,p10, nrow= 1)
```



```{r, warning= F, fig.width= 10, fig.height= 4, echo = FALSE, include=FALSE}
p11 <- data %>%
  group_by(age) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg) %>%
  dplyr::select(group = age, turnout_rate) %>%
  ggplot( aes(x = group, y = turnout_rate)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Age") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), vjust = -0.5) +
  ggtitle("Turnout rate vs. Age") +
    theme(plot.title = element_text(hjust = 0.5))+
    coord_flip()

p12 <- data %>%
  group_by(age) %>%
  summarize(n = sum(total_reg), .groups="drop") %>%
  ggplot( aes(x = age, y = n)) +
  geom_bar(stat = "identity") +
  xlab("Party") + ylab("Sample size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.2) +
  ggtitle("Registered Voters vs. Age") +
    theme(plot.title = element_text(hjust = 0.5)) +
  ylim(0,8.8e05) +
  coord_flip()

grid.arrange(p11,p12, nrow= 1)

```

### Gender & Party

Next we move on to EDA related to interactions. We're interested in any potential differences in turnout rate for females and males with various party affiliations. In the graph below we see that females have higher turnout rates than males for each party. People with unknown genders, however, often have the highest turnout rate. For parties with substantial turnout rates, the Republican and Democrat parties, as well as those unaffiliated with a party, females had a larger number of voters registered than males and people with unknown genders had a much smaller number of voters registered. Note that, even after combining the Green and Constitutional parties, the number of registered voters for these parties is still quite small, relative to the other parties.

```{r, warning= F, fig.width= 10, echo = FALSE}
p13 <- data %>%
  group_by(sex_code, party_cd) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg,
         group = paste0(sex_code, " with ", party_cd)) %>%
  dplyr::select(group = group, turnout_rate, sex_code, party_cd) %>%
  ggplot( aes(x = group, y = turnout_rate, fill = party_cd)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Sex * Party") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), hjust = -0.3) +
  coord_flip() +
  ggtitle("Turnout rate vs. Sex*Party") +
    theme(plot.title = element_text(hjust = 0.5))

p14 <- data %>%
  group_by(sex_code, party_cd) %>%
  summarize(n = sum(total_reg), .groups = "drop") %>%
  mutate(group = paste0(sex_code, " with ", party_cd)) %>%
  ggplot( aes(x = group, y = n, fill = party_cd)) +
  geom_bar(stat = "identity") +
  xlab("Age * Party") + ylab("Size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.3) +
  coord_flip() +
  ggtitle("Registered Voters vs. Age*Party") +
    theme(plot.title = element_text(hjust = 0.5))

legend <- get_legend(p13)

grid.arrange(widths = c(3, 3, 1),p13 + theme(legend.position="none"),
             p14 + theme(legend.position="none"), nrow= 1,legend)
```

###  Age & Party

We are also interested in the potential difference between age groups in various political parties. From the graphs below we see that the age group of 66 and older has the highest turnout rate for every political party and the age group 18-25 has the lowest. In general, it seems that, across parties, as age increases, turnout rate also increases. As noted previously, the age group 41-65 has the largest number of registered voters for both of the main parties, Republican and Democrat, and for unaffiliated voters.

```{r, warning= F, fig.width= 10, echo = FALSE}
p15 <- data %>%
  group_by(age, party_cd) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg,
         group = paste0(age, " with ", party_cd)) %>%
  dplyr::select(group = group, turnout_rate, age, party_cd) %>%
  ggplot( aes(x = group, y = turnout_rate, fill = party_cd)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Age * Party") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), hjust = -0.3) +
  coord_flip() +
  ggtitle("Turnout rate vs. Age*Party") +
    theme(plot.title = element_text(hjust = 0.5))

p16 <- data %>%
  group_by(age, party_cd) %>%
  summarize(n = sum(total_reg), .groups = "drop") %>%
  mutate(group = paste0(age, " with ", party_cd)) %>%
  ggplot( aes(x = group, y = n, fill = party_cd)) +
  geom_bar(stat = "identity") +
  xlab("Age * Party") + ylab("Size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.3) +
  coord_flip() +
  ggtitle("Registered Voters vs. Age*Party") +
    theme(plot.title = element_text(hjust = 0.5))

legend <- get_legend(p15)

grid.arrange(widths = c(3, 3, 1),p15 + theme(legend.position="none"),
             p16 + theme(legend.position="none"), nrow= 1,legend)

```


### Age & Race

We are also interested in a potential relationship between age and race. In the graphs below we see a general trend that, across races, as the age increase so too does the turnout rate. We also see that, within each age group, white people make up the majority of registered voters.

```{r, warning= F, fig.width= 10, echo = FALSE}
p17 <- data %>%
  group_by(age, race_code) %>%
  summarise(total_reg = sum(total_reg),
            total_vot = sum(total_vot), .groups = "drop") %>%
  mutate(turnout_rate = total_vot / total_reg,
         group = paste0(age, " with ", race_code)) %>%
  dplyr::select(group = group, turnout_rate, age, race_code) %>%
  ggplot( aes(x = group, y = turnout_rate, fill = race_code)) +
  geom_bar(stat = "identity") +
  ylim(0,1) +
  xlab("Age * Race") + ylab("Turnout rate") +
  geom_text(aes(label=format(turnout_rate, digits = 2)), hjust = -0.3) +
  coord_flip() +
  ggtitle("Turnout rate vs. Age*Race") +
    theme(plot.title = element_text(hjust = 0.5))

p18 <- data %>%
  group_by(age, race_code) %>%
  summarize(n = sum(total_reg), .groups = "drop") %>%
  mutate(group = paste0(age, " with ", race_code)) %>%
  ggplot( aes(x = group, y = n, fill = race_code)) +
  geom_bar(stat = "identity") +
  xlab("Age * Party") + ylab("Size") +
  geom_text(aes(label=format(n, digits = 2)), hjust = -0.3) +
  coord_flip() +
  ggtitle("Registered Voters vs. Age*Race") +
    theme(plot.title = element_text(hjust = 0.5))

legend <- get_legend(p17)

grid.arrange(widths = c(3, 3, 1),p17 + theme(legend.position="none"),
             p18 + theme(legend.position="none"), nrow= 1,legend)


```

```{r, echo = FALSE}
data <- data %>%
  mutate(total_vot = as.numeric(total_vot), 
         total_reg = as.numeric(total_reg),
         county_desc = as.factor(county_desc),
         party_cd = as.factor(as.character(party_cd)),
         race_code = as.factor(race_code),
         sex_code = as.factor(sex_code),
         ethnic_code = as.factor(ethnic_code),
         age = as.factor(age))

```


# Model

With our exploration of the data complete, we now begin our model building. From the research questions we have an idea of what must be included in the model; this includes main effect for party, sex, and age, as well as random intercepts by county. This will be our base model. From the research questions we also know that we likely need an interaction term between age and party as well as sex and party. Additionally, since our dependent variable, turnout rate, is between 0 and 1, we know we should use a logistic mixed effects model. Below we see the output from forward selection. We see that the last model, with interactions between sex and party, age and party, as well as age and race, has the lowest BIC and AIC so this will be our final model.

$$
\begin{aligned}
log\left(\frac{\pi_{ij}}{1-\pi_{ij}}\right)&=\beta_0+\sum_k\beta_{1k}\mathbb{1}[P_{ij}=k]+\sum_k\beta_{2k}\mathbb{1}[R_{ij}=k]+\sum_k\beta_{3k}\mathbb{1}[E_{ij}=k]+\sum_k\beta_{4k}\mathbb{1}[S_{ij}=k]\\
&+\sum_k\beta_{5k}\mathbb{1}[A_{ij}=k]+\sum_{k,l}\beta_{6k}\mathbb{1}[S_{ij}=k]\mathbb{1}[P_{ij}=k]+\sum_{k,l}\beta_{7k}\mathbb{1}[A_{ij}=k]\mathbb{1}[P_{ij}=k]\\
&+\sum_{k,l}\beta_{8k}\mathbb{1}[A_{ij}=k]\mathbb{1}[R_{ij}=k] +b_{0j}
\end{aligned}
$$
where $\pi_{ij}=Pr(y_{ij}=1)$ and $b_{0j}\overset{\text{iid}}{\sim} N(0,\sigma^2)$ and

* $j$ indexes county

* $i$ indexes observation

* $P_{ij}$ is the Party code

* $R_{ij}$ is the Race code

* $E_{ij}$ is the Ethnic code

* $S_{ij}$ is the sex code

* $A_{ij}$ is the Age group

```{r, cache = T, echo = FALSE}
# initial
mod1 <- glmer(cbind(total_vot, total_reg - total_vot) ~
                      party_cd  + sex_code + age + (1|county_desc),
                    data = data, family = binomial,
              control=glmerControl(optimizer = "bobyqa"))


mod2 <- glmer(cbind(total_vot, total_reg - total_vot) ~
                      party_cd + race_code  + sex_code + age + (1|county_desc),
                    data = data, family = binomial,
              control=glmerControl(optimizer = "bobyqa"))


mod3 <- glmer(cbind(total_vot, total_reg - total_vot) ~
                      party_cd + race_code + ethnic_code + sex_code + age + (1|county_desc),
                    data = data, family = binomial,
              control=glmerControl(optimizer = "bobyqa"))


mod4 <- glmer(cbind(total_vot, total_reg - total_vot) ~
                      -1 + race_code + ethnic_code + sex_code + age + (1 | county_desc),
                    data = data, family = binomial,
              control=glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=2e5)))


mod5 <- glmer(cbind(total_vot, total_reg - total_vot) ~
                  party_cd + race_code + ethnic_code + sex_code + age +
                  sex_code:party_cd + age:party_cd + (1|county_desc),
                data = data, family = binomial,
              control=glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=2e5)))


mod6 <- glmer(cbind(cbind(total_vot, total_reg - total_vot)) ~
                  party_cd + race_code + ethnic_code + sex_code + age +
                  sex_code:party_cd + age:party_cd + age:race_code + (1|county_desc),
                data = data, family = binomial,
      control=glmerControl(optimizer = "bobyqa",optCtrl=list(maxfun=2e5)))

```


```{r, echo = FALSE}

model <- c("Base model",
           "Add race",
           "Add race and ethnic",
           "Without intercept",
           "Add the interaction of sex:party, and age:party",
           "Add the interaction of sex:party, age:party, and age:race")
LRT <- c("",
         round(anova(mod1,mod2)$`Pr(>Chisq)`[2],4),
         round(anova(mod2,mod3)$`Pr(>Chisq)`[2],4),
         round(anova(mod3,mod4)$`Pr(>Chisq)`[2],4),
         round(anova(mod3,mod5)$`Pr(>Chisq)`[2],4),
         round(anova(mod3,mod6)$`Pr(>Chisq)`[2],4))
BIC_score <- sapply(c(mod1, mod2, mod3, mod4, mod5, mod6), BIC)
AIC_score <- sapply(c(mod1, mod2, mod3, mod4,mod5, mod6), AIC)
data.frame("Model" = model, 'LRT p-value' = LRT, 'AIC' = AIC_score, 'BIC' = BIC_score) %>%
  kable(caption = "Forward model selection") %>%
    kable_styling(latex_options = c("HOLD_position","striped"))

```

```{r, echo = FALSE}
chart_fixef <- function(model) {
 summary(model)$coefficients %>%
    as.data.frame() %>%
    mutate(`lower bound` = round(Estimate - 1.96 * `Std. Error`, 4),
           `upper bound` = round(Estimate + 1.96 * `Std. Error`, 4)) %>%
    # mutate(`95% CI` = paste0(
    #   '[', 
    #   round(Estimate - 1.96 * `Std. Error`, 4), ', ', 
    #   round(Estimate + 1.96 * `Std. Error`, 4), ']' )
    # ) %>%
    dplyr::select(Estimate, `Std. Error`, `95% lower`, `95% upper`)
}
```



## Model Assessment

From our EDA it can reasonably be assumed that the linearity condition is met for our model and that multicollinearity is not an issue. As we see in the binned residual plot below, there may cause for some concern as some points with expected values between 0.8 and 0.9 fall out of the range of the confidence bands. However, relative to the amount of data we have, these 8 points, in addition to 7 other scattered points outside the confidence bands, don't point to our model being incorrect. We see that the model has an AUC around 0.7 which is satisfactory and much better than a coin flip. Our model seems to more accurately identify positives than negatives as well. We also see a plot of the random effects for each county and observe clear heterogeneity across counties. Robeson county has the smallest estimate and is quite far from the nearest county, Scotland, while Cabarrus has the largest estimate. A table with the estimates and corresponding confidence intervals is included in the appendix.


```{r, echo = FALSE}

# expand data from aggregated format
data_expand <- data %>%
  mutate(resp = map2(total_vot, total_reg, ~ c(
    rep(1, .x), rep(0, .y - .x)
  ))) %>%
  unnest(cols = c(resp)) %>%
  dplyr::select(-c(total_reg, total_vot))

# split into train and test
sample <- sample(c(TRUE, FALSE), nrow(data_expand), replace=TRUE, prob=c(0.7,0.3))
train <- data_expand[sample,]
test <- data_expand[!sample,]

# fit model on train data

### fit any model you like on unaggregated train data 
### will take a while...

predicted <- predict(mod6, test, type="response")
rocobj <- roc(test$resp, predicted)


ggroc(rocobj, size=1) +
  coord_fixed() +
  scale_x_reverse(
    name = "Specificity", 
    limits = c(1,0), 
    expand = c(0.001,0.001)
  ) + 
  scale_y_continuous(
    name = "Sensitivity", 
    limits = c(0,1), 
    expand = c(0.001, 0.001)
  ) +
  geom_abline(intercept=1, slope=1, linetype="dashed", color="red") +
  labs(title=paste("AUC:", round(rocobj$auc, 3))) +
  theme_bw()
# fit model on full data

# Fixed Effects
# temp <- chart_fixef(mod6)
# 
#   temp[1:50,] %>%
#     kable(digits=3) %>%
#     kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
#     kable_classic()
#   
#   temp[51:56,] %>%
#     kable(digits=3) %>%
#     kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
#     kable_classic()

# Uncomment below to show values for random effects in appendix

# labs.df <- as.data.frame(ranef(mod6))
# labs.df <- labs.df %>% 
#   mutate(Lower = condval - 2*condsd) %>%
#   mutate(Upper = condval + 2*condsd) %>%
#   mutate(Estimate = exp(condval)) %>%
#   mutate(SD = exp(condsd)) %>% 
#   mutate(lower = Estimate - 2*SD) %>%
#   mutate(upper = Estimate + 2*SD)
#   
# labs.df <- labs.df[, 3:11]
# colnames(labs.df) <- c("County", "Estimate", "SD","Lower", "Upper", "E.Estimate", "E.SD", "E.Lower", "E.Upper")
# 
# kable(labs.df[,c(1, 6,8:9)], digits = 3)


# # Random Effects
# dotplot(ranef(mod6))$county_desc


# test <- binned_residuals(mod6)
binnedplot(fitted(mod6), y = resid(mod6))
```


# Conclusion

Now, we can answer the research questions based on the model results.

**Q1: How did different demographic subgroups vote in the 2020 general elections?**

### Party

Notice that our final model incorporated the interaction terms `sex:party` and `age:party`, we should interpret the effects of party at the baseline levels of the other two terms (female and age 18-25).

```{r, echo = FALSE}
data.frame(chart_fixef(mod6)[2:5,]) %>%
  kable(caption = "Estiamtes and 95% CI of Fixed Effects for Party",
        digits=4) %>%
  kable_styling(latex_options = c("HOLD_position","striped"))
```


Holding all other predictors unchanged:

an 18-25 year old female DEM voter has $e^{0.3477} = 1.4158$ times (a 41% increase) the odds of voting

an 18-25 year old female LIB voter has $e^{-0.2886} = 0.7493$ times (a 25% decrease) the odds of voting

an 18-25 year old female REP voter has $e^{0.3248} = 1.3838$ times (a 38% increase) the odds of voting

an 18-25 year old female UNA voter has $e^{-0.1791} = 0.8360$ times (a 17% decrease) the odds of voting (this effect is not significant since the 95% CI covers 0)

compared with an 18-25 year old female GRE/CST voter.

### Race

```{r, echo = FALSE}
chart_fixef(mod6)[6:11,] %>%
  kable(caption = "Estiamtes and 95% CI of Fixed Effects for Race",
        digits=4) %>%
  kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
    kable_classic()
```

Holding all other predictors unchanged:

an 18-25 year old voter with undesignated race has $e^{0.3584} = 1.4310$ times (a 43% increase) the odds of voting

an 18-25 year old Black voter has $e^{-0.3441} = 0.7089$ times (a 29% decrease) the odds of voting

an 18-25 year old White voter has $e^{0.2318} = 1.2609$ times (a 26% increase) the odds of voting

an 18-25 year old Asian voter has $e^{0.1517} = 1.1638$ times (a 16% increase) the odds of voting

an 18-25 year old Islander voter has $e^{-0.2409} = 0.7859$ times (a 21% decrease) the odds of voting

an 18-25 year old voter in other race has $e^{-0.1098} = 0.8960$ times (a 10% decrease) the odds of voting

compared with an 18-25 year old multiracial voter.

### Ethnic

```{r, echo = FALSE}
chart_fixef(mod6)[12:13,] %>%
  kable(caption = "Estiamtes and 95% CI of Fixed Effects for Ethnic",
        digits=4) %>%
  kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
    kable_classic()
```


Holding all other predictors unchanged:

a non Hispanic/Latino voter has $e^{0.4438} = 1.5586$ times (a 56% increase) the odds of voting

a voter with unkown ethnic has $e^{0.3618} = 1.4359$ times (a 44% increase) the odds of voting

compared with a Hispanic/Latino voter.

### Sex

```{r, echo = FALSE}
chart_fixef(mod6)[14:15,] %>%
  kable(caption = "Estiamtes and 95% CI of Fixed Effects for Sex",
        digits=4) %>%
  kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
    kable_classic()
```

Holding all other predictors unchanged:

a male CST/GRE voter has $e^{-0.0728} = 0.9298$ times (a 7% decrease) the odds of voting

a CST/GRE voter with unknown gender has $e^{0.1790} = 1.1960$ times (a 20% increase) the odds of voting

compared with a female CST/GRE voter.

However, neither of these coefficients are significant since none of the 95% CIs cover 0.


### Age

```{r, echo = FALSE}
chart_fixef(mod6)[16:18,] %>%
  kable(caption = "Estiamtes and 95% CI of Fixed Effects for Age",
        digits=4) %>%
  kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
    kable_classic()
```

Holding all other predictors unchanged:

a 26-40 year old multiracial CST/GRE voter has $e^{0.0492} = 1.0504$ times (a 5% increase) the odds of voting (this effect is not significant since the 95% CI covers 0)

a 41-65 year old multiracial CST/GRE voter has $e^{0.3871} = 1.4727$ times (a 47% increase) the odds of voting

an over 66 year old multiracial CST/GRE voter has $e^{0.4609} = 1.5855$ times (a 59% increase) the odds of voting (this effect is not significant since the 95% CI covers 0)

compared with an 18-25 year old multiracial CST/GRE voter.



**Q2: Did the overall probability or odds of voting differ by county in 2020? Which counties differ the most from other counties?**

```{r, echo = FALSE}
dotplot(ranef(mod6))$county_desc
```


**Q3: How did the turnout rates differ between females and males for the different party affiliations?**

```{r, echo = FALSE}
chart_fixef(mod6)[19:26,] %>%
  kable(caption = "Estiamtes and 95% CI of Fixed Effects for Party:Sex Interaction",
        digits=3) %>%
  kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
    kable_classic()
```


**Q4: How did the turnout rates differ between age groups for the different party affiliations?**

```{r, echo = FALSE}
chart_fixef(mod6)[27:38,] %>%
  kable(caption = "Estiamtes and 95% CI of Fixed Effects for Party:Age Interaction",
        digits=3) %>%
  kable_styling(full_width=FALSE,latex_options = c("hold_position", "repeat_header")) %>%
    kable_classic()
```


Due to the large number of coefficients, we will only interpret a few for demonstration.

Our baseline is that of a female aligned with party ??, of mixed race and Hispanic/Latina ethnicity, in the age category 18-25. The odds of this person voting is .

Holding all else constant, a male aligned with party ??, of mixed race and Hispanic/Latino ethnicity, in the age category 18-25 has exp() times the odds of the baseline of voting.


# Strengths and Limitations

Limitations of our model include the fact that during data cleaning we dropped rows that contained missing values. While we are working with almost 2 million observations, we do have quite a few small demographic groups, especially for our interaction terms. A possible alternative would have been to impute values for the missing data so that we could keep as many rows as possible. Obviously imputation comes with it's own set of assumptions and limitations. 

Other limitations ?

A major strength of our model is the inclusion of random intercepts by county which allows us to understand the difference in turnout rate between each county. 

Other strengths ?
  
  